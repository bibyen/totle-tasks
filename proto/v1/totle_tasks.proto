syntax = "proto3";

package totle_tasks.v1;

import "google/api/field_behavior.proto";
import "google/api/resource.proto";
import "google/protobuf/empty.proto";
import "google/protobuf/field_mask.proto";
import "google/protobuf/timestamp.proto";

option go_package = "github.com/bibyen/totle-tasks/internal/pb/v1;totletasksv1";

/*
 * ==========================================
 * GOAL SERVICE
 * Handles the lifecycle of individual tasks.
 * ==========================================
 */
service GoalService {
  // Creates a new goal for the user's bank.
  rpc CreateGoal(CreateGoalRequest) returns (Goal);

  // Retrieves a specific goal by resource name.
  rpc GetGoal(GetGoalRequest) returns (Goal);

  // Lists only goals that are NOT currently assigned to any BingoCard.
  // This powers the "Available Tasks" picker in the UI.
  rpc ListAvailableGoals(ListAvailableGoalsRequest) returns (ListAvailableGoalsResponse);

  // Retrieves multiple goals in one round-trip. 
  // Used by BingoService to hydrate the grid layout.
  rpc BatchGetGoals(BatchGetGoalsRequest) returns (BatchGetGoalsResponse);

  // Updates goal details (title, completion, etc.) using a FieldMask.
  rpc UpdateGoal(UpdateGoalRequest) returns (Goal);

  // Deletes a goal. 
  // Validation: Implementation must reject deletion if goal.is_assigned is true.
  rpc DeleteGoal(DeleteGoalRequest) returns (google.protobuf.Empty);
}

/*
 * ==========================================
 * BINGO SERVICE
 * Handles the monthly grid arrangement and hydration.
 * ==========================================
 */
service BingoService {
  // Retrieves the card for a specific month (YYYY-MM).
  // Use View.FULL to populate goal_data in the response via BatchGetGoals.
  rpc GetBingoCard(GetBingoCardRequest) returns (BingoCard);

  // Updates the grid configuration (assigning/moving goals).
  rpc UpdateBingoCard(UpdateBingoCardRequest) returns (BingoCard);
}

/*
 * =========================
 * Resources
 * =========================
 */

message Goal {
  option (google.api.resource) = {
    type: "totletasks.googleapis.com/Goal"
    pattern: "users/{user}/goals/{goal}"
  };

  // Output only. Format: users/{user}/goals/{goal_id}
  string name = 1 [(google.api.field_behavior) = OUTPUT_ONLY];

  string title = 2 [(google.api.field_behavior) = REQUIRED];

  bool completed = 3;

  // Output only. True if this goal is placed on a BingoCard.
  // Prevents deletion and exclusion from 'Available' list.
  bool is_assigned = 4 [(google.api.field_behavior) = OUTPUT_ONLY];

  enum Visibility {
    VISIBILITY_UNSPECIFIED = 0;
    PRIVATE = 1;
    PUBLIC = 2;
  }
  Visibility visibility = 5;

  google.protobuf.Timestamp create_time = 6 [(google.api.field_behavior) = OUTPUT_ONLY];
}

message BingoCard {
  option (google.api.resource) = {
    type: "totletasks.googleapis.com/BingoCard"
    pattern: "users/{user}/bingoCards/{bingo_card}"
  };

  // Output only. Format: users/{user}/bingoCards/{YYYY-MM}
  string name = 1 [(google.api.field_behavior) = OUTPUT_ONLY];

  message Slot {
    // The resource name of the goal.
    string goal_name = 1 [(google.api.resource_reference).type = "totletasks.googleapis.com/Goal"];
    
    // Output only. Populated only if GetBingoCardRequest.view == VIEW_FULL.
    Goal goal_data = 2 [(google.api.field_behavior) = OUTPUT_ONLY];
  }

  message GridRow {
    repeated Slot slots = 1;
  }

  // The 2D grid structure.
  repeated GridRow grid = 2;
  
  // Immutables lock the card to its specific time bucket.
  int32 year = 3 [(google.api.field_behavior) = IMMUTABLE];
  int32 month = 4 [(google.api.field_behavior) = IMMUTABLE];

  google.protobuf.Timestamp update_time = 5 [(google.api.field_behavior) = OUTPUT_ONLY];
}

/*
 * =========================
 * Request/Response Messages
 * =========================
 */

message CreateGoalRequest {
  string parent = 1 [(google.api.field_behavior) = REQUIRED];
  Goal goal = 2 [(google.api.field_behavior) = REQUIRED];
}

message GetGoalRequest {
  string name = 1 [(google.api.field_behavior) = REQUIRED];
}

message ListAvailableGoalsRequest {
  // Parent format: users/{user}
  string parent = 1 [(google.api.field_behavior) = REQUIRED];
  int32 page_size = 2;
  string page_token = 3;
}

message ListAvailableGoalsResponse {
  repeated Goal goals = 1;
  string next_page_token = 2;
}

message BatchGetGoalsRequest {
  // Parent format: users/{user}
  string parent = 1 [(google.api.field_behavior) = REQUIRED];
  repeated string names = 2 [(google.api.field_behavior) = REQUIRED];
}

message BatchGetGoalsResponse {
  repeated Goal goals = 1;
}

message UpdateGoalRequest {
  Goal goal = 1 [(google.api.field_behavior) = REQUIRED];
  google.protobuf.FieldMask update_mask = 2;
}

message DeleteGoalRequest {
  string name = 1 [(google.api.field_behavior) = REQUIRED];
}

message GetBingoCardRequest {
  // Format: users/{user}/bingoCards/{YYYY-MM}
  string name = 1 [(google.api.field_behavior) = REQUIRED];

  enum View {
    VIEW_UNSPECIFIED = 0;
    BASIC = 1; // Returns slot goal_names only.
    FULL = 2;  // Hydrates goal_data for all slots.
  }
  View view = 2;
}

message UpdateBingoCardRequest {
  BingoCard bingo_card = 1 [(google.api.field_behavior) = REQUIRED];
  google.protobuf.FieldMask update_mask = 2;
}
